"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){l=!0,i=e},f:function(){try{a||null==n.return||n.return()}finally{if(l)throw i}}}}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(e){var t=_isNativeReflectConstruct();return function(){var n,r=_getPrototypeOf(e);if(t){var o=_getPrototypeOf(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return _possibleConstructorReturn(this,n)}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach(function(t){_defineProperty(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i=[],a=!0,l=!1;try{for(n=n.call(e);!(a=(r=n.next()).done)&&(i.push(r.value),!t||i.length!==t);a=!0);}catch(e){l=!0,o=e}finally{try{a||null==n.return||n.return()}finally{if(l)throw o}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,r,o,i,a){try{var l=e[i](a),s=l.value}catch(e){return void n(e)}l.done?t(s):Promise.resolve(s).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise(function(r,o){var i=e.apply(t,n);function a(e){asyncGeneratorStep(i,r,o,a,l,"next",e)}function l(e){asyncGeneratorStep(i,r,o,a,l,"throw",e)}a(void 0)})}}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var CoreElement=function e(){_classCallCheck(this,e)},element=new CoreElement,elem_proto=Object.getPrototypeOf(element);function loadImage(e){return new Promise(function(t,n){var r=new Image;r.onload=function(){t(r)},r.onerror=function(){n("Unable to load image")},r.src=e})}function loadJSON(e){return new Promise(function(t,n){$.getJSON(e).done(function(e){t(e)}).fail(function(e,t,r){n(r)})})}function range(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=null!=t?e:0,o=null!=t?t:e,i=0==n?1:n,a=Math.floor((o-r)/i),l=[],s=0,u=r;s<a;s++,u+=i)l[s]=u;return l}window.loadImage=loadImage,window.range=range;var fdiv=function(e,t){return Math.floor(e/t)},Sprite=function(){function e(t,n,r){_classCallCheck(this,e),this._img=t,this._animations=r,this._selected=null,this._height=t.height,this._width=n<=0||null==n?this._height:n,this._numImages=Math.floor(t.width/this._width),this._speed=16,this._frames=range(0,this._numImages),this._cycles=1/0,this._index=0,this._accumulator=0}return _createClass(e,[{key:"setAnimation",value:function(e){var t;if(e!==this._selected){this._selected=null!=e&&e in this._animations?e:null;var n=null!=this._selected?this._animations[this._selected]:{};this._speed=null==n.speed||n.speed<1?16:n.speed,this._frames=null!==(t=n.frames)&&void 0!==t?t:range(0,this._numImages),this._cycles=null==n.cycles||n.cycles<0?1/0:n.cycles;for(var r=0;r<this._frames.length;r++)this._frames[r]=Math.abs(this._frames[r])%this._numImages;this._index=0,this._accumulator=0}}},{key:"getAnimation",value:function(){return this._selected}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"update",value:function(e){this._accumulator+=e,this._index+=fdiv(this._accumulator,this._speed),this._accumulator%=this._speed,this._cycles-=fdiv(this._index,this._frames.length),this._index%=this._frames.length,this._cycles<=0&&(this._cycles=0,this._index=this._frames.length-1)}},{key:"draw",value:function(e,t,n,r,o){var i=this._frames[this._index],a=this._width*i;e.drawImage(this._img,a,0,this._width,this._height,t,n,r,o)}}]),e}();function getSpriteBuilder(e){return _getSpriteBuilder.apply(this,arguments)}function _getSpriteBuilder(){return(_getSpriteBuilder=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,loadImage(t.image);case 2:return e.t0=e.sent,e.t1=t.width,e.t2=t.animations,e.t3=function(){return new Sprite(this._img,this._width,this._animations)},e.abrupt("return",{_img:e.t0,_width:e.t1,_animations:e.t2,buildSprite:e.t3});case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}function _bound(e,t,n){return Math.max(t,Math.min(n,e))}window.Sprite=Sprite;var Camera=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1/3;_classCallCheck(this,e),this._canvas=t,this._minPixelsShown=n,this._zoom=1,this._track=null,this._centerPoint=[0,0],this._trackBoxRatio=r}return _createClass(e,[{key:"setCenterPoint",value:function(e){this._centerPoint=[e[0],e[1]]}},{key:"getCenterPoint",value:function(){return this._centerPoint}},{key:"setTrackedObject",value:function(e){this._track=e}},{key:"getMinimumPixelsShown",value:function(){return this._minPixelsShown}},{key:"setMinimumPixelsShown",value:function(e){this._minPixelsShown=e}},{key:"update",value:function(e){var t=this,n=Math.min(this._canvas.width,this._canvas.height);if(this._zoom=n/this._minPixelsShown,null!=this._track&&"getHitBox"in this._track){var r=_slicedToArray(this._track.getHitBox().map(function(e){return e*t._track._blockSize}),4),o=r[0],i=r[1],a=(r[2],r[3],_slicedToArray(this.getBounds(),4)),l=a[0],s=a[1],u=a[2],c=a[3],h=_slicedToArray(this._centerPoint,2),f=h[0],_=h[1],d=[f-this._trackBoxRatio*(u/2),_-this._trackBoxRatio*(c/2),this._trackBoxRatio*u,this._trackBoxRatio*c];o<d[0]?d[0]=o:o>d[0]+d[2]&&(d[0]=o-d[2]),i<d[1]?d[1]=i:i>d[1]+d[3]&&(d[1]=i-d[3]),this._centerPoint=[d[0]+d[2]/2,d[1]+d[3]/2];var p=_slicedToArray(this.getBounds(),4);l=p[0],s=p[1],u=p[2],c=p[3];var y=this._centerPoint[0]-l,v=this._centerPoint[1]-s,m=[_bound(l,0,e[0]-u),_bound(s,0,e[1]-c)],k=m[0],g=m[1];this._centerPoint=[k+y,g+v]}}},{key:"getBounds",value:function(){var e=_slicedToArray(this._centerPoint,2),t=e[0],n=e[1],r=this._canvas.width/this._zoom,o=this._canvas.height/this._zoom;return[t-r/2,n-o/2,r,o]}},{key:"transform",value:function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],o=_slicedToArray(this.getBounds(),4),i=o[0],a=o[1],l=o[2],s=o[3];return[(n-i)/l*this._canvas.width,(r-a)/s*this._canvas.height]}},{key:"transformBox",value:function(e){var t=_slicedToArray(e,4),n=t[0],r=t[1],o=t[2],i=t[3],a=_slicedToArray(this.transform([n,r]),2),l=a[0],s=a[1],u=_slicedToArray(this.transform([n+o,r+i]),2);return[l,s,u[0]-l,u[1]-s]}},{key:"reverseTransform",value:function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],o=_slicedToArray(this.getBounds(),4),i=o[0],a=o[1],l=o[2],s=o[3];return[n/this._canvas.width*l+i,r/this._canvas.height*s+a]}}]),e}();function _makeEmptyLevel(){for(var e={blockSize:32,chunkSize:16,numChunks:[10,10],player:null,chunks:[]},t=e.chunks,n=0;n<e.numChunks[0];n++){t[n]=[];for(var r=0;r<e.numChunks[1];r++)t[n][r]=_makeEmptyChunk(e.chunkSize)}return e}function _makeEmptyChunk(e){for(var t={entities:[],blocks:[]},n=0;n<e;n++){t.blocks[n]=[];for(var r=0;r<e;r++)t.blocks[n][r]=null}return t}window.Camera=Camera,elem_proto.makeBaseGame=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o,i,a,l,s,u,c,h,f=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:c=function(e){var r=n.canvas.getBoundingClientRect(),o=r.width,i=r.height;n.canvas.width=o,n.canvas.height=i,n.painter.imageSmoothingEnabled=!1,n.painter.mozImageSmoothingEnabled=!1,n.painter.webkitImageSmoothingEnabled=!1,n.painter.msImageSmoothingEnabled=!1;var a=null==n.lastTimeStamp?0:e-n.lastTimeStamp;t(a,n),n.lastTimeStamp=e,n.keepRunning&&window.requestAnimationFrame(c)},n=f.length>1&&void 0!==f[1]?f[1]:{},r=f.length>2&&void 0!==f[2]?f[2]:{},o=f.length>3&&void 0!==f[3]?f[3]:320,i=$($.parseHTML("<div style='position: fixed; z-index: 300; top: 0; bottom: 0; left: 0; right: 0; background-color: white;'></div>")),a=$($.parseHTML("<canvas style='width: 100%; height: 100%;'>Your browser doesn't support canvas!</canvas>")),l=$($.parseHTML("<button style='position: absolute; top: 0; right: 0;'>X</button>")),i.append(a),i.append(l),$(document.body).append(i),(n=_objectSpread({},n)).lastTimeStamp=null,n.keepRunning=!0,n.canvas=a[0],n.painter=n.canvas.getContext("2d"),n.keysPressed={},n.mousePressed=!1,n.mouseLocation=[0,0],n.camera=new Camera(a[0],o),n.sprites={},e.t0=regeneratorRuntime.keys(null!==(u=r.sprites)&&void 0!==u?u:{});case 21:if((e.t1=e.t0()).done){e.next=28;break}return s=e.t1.value,e.next=25,getSpriteBuilder(r.sprites[s]);case 25:n.sprites[s]=e.sent,e.next=21;break;case 28:if(e.prev=28,null==r.level){e.next=35;break}return e.next=32,loadJSON(r.level);case 32:e.t2=e.sent,e.next=36;break;case 35:e.t2={};case 36:n.level=e.t2,e.next=42;break;case 39:e.prev=39,e.t3=e.catch(28),n.level={};case 42:i.mousedown(function(e){return n.mouseLocation=[e.offsetX,e.offsetY],n.mousePressed=!0,!1}),i.mousemove(function(e){n.mouseLocation=[e.offsetX,e.offsetY]}),i.mouseup(function(e){return n.mouseLocation=[e.offsetX,e.offsetY],n.mousePressed=!1,!1}),l.mousedown(!1),l.mouseup(!1),l.mousemove(!1),(h=$(document)).off("keydown"),h.on("keydown.gameloop",function(e){n.keysPressed[e.code]=!0}),h.on("keyup.gameloop",function(e){delete n.keysPressed[e.code]}),l.click(function(){i.remove(),n.keepRunning=!1,h.off(".gameloop");try{Jupyter.keyboard_manager.bind_events()}catch(e){console.log(e)}}),window.requestAnimationFrame(c);case 55:case"end":return e.stop()}},e,null,[[28,39]])}));return function(t){return e.apply(this,arguments)}}();var GameObject=function(){function e(t,n,r,o){_classCallCheck(this,e),this.x=t,this.y=n,this._blockSize=r}return _createClass(e,[{key:"update",value:function(e,t){}},{key:"draw",value:function(e,t,n){}},{key:"drawPreview",value:function(e,t,n){}},{key:"getLocation",value:function(){return[this.x,this.y]}},{key:"setLocation",value:function(e){var t=_slicedToArray(e,2);this.x=t[0],this.y=t[1]}},{key:"toJSON",value:function(){var e={_$type:this.constructor.name};for(var t in this)t.startsWith("_")||(e[t]=this[t]);return e}},{key:"getHitBox",value:function(){return[this.x,this.y,1,1]}}],[{key:"fromJSON",value:function(e,t,n){var r=new this(e.x,e.y,t,n);for(var o in e)o.startsWith("_")||(r[o]=e[o]);return r}}]),e}();window.GameObject=GameObject;var GameCollisionObject=function(e){_inherits(n,GameObject);var t=_createSuper(n);function n(e,r,o,i){var a;return _classCallCheck(this,n),(a=t.call(this,e,r,o,i)).___px=e,a.___py=r,a._vx=null,a._vy=null,a._collisionSides={left:!0,top:!0,right:!0,bottom:!0},a._movable=!1,a._solid=!0,a.___covered=[!1,!1],a}return _createClass(n,[{key:"__intersection",value:function(e,t,n,r){var o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],i=_slicedToArray(e,3),a=i[0],l=i[1],s=i[2],u=_slicedToArray(n,3),c=u[0],h=u[1],f=u[2];if(l!=h)throw"Axes did not match!";var _=(l+1)%2,d=(c[_]-a[_])/(t[_]-r[_]);if(d==1/0||d==-1/0)return[1/0,0,null];if(d!=d)return[1/0,0,null];var p=a[l]+t[l]*d,y=c[l]+r[l]*d,v=a[_]+t[_]*d;if(p+s<y||y+f<p)return[1/0,0,null];if(!o&&(d>1||d<-5))return[1/0,0,null];var m=Math.min.apply(null,[y-(p+s),y+f-p].map(Math.abs));return d<0&&(d=1+Math.abs(d)),[d,m,[[0!=l?v:y,1!=l?v:y],l,f]]}},{key:"__getCollisionSides",value:function(){for(var e=_slicedToArray(this.getHitBox(),4),t=e[0],r=e[1],o=e[2],i=e[3],a=[this.___px,this.___py],l=[[[t=a[0],(r=a[1])+i],0,o],[[t,r],0,o],[[t+o,r],1,i],[[t,r],1,i]],s=0;s<n.sideNames.length;s++)l[s]=this._collisionSides[n.sideNames[s]]?l[s]:null;return l}},{key:"__getDisplacementVector",value:function(){return[this.x-this.___px,this.y-this.___py]}},{key:"handleCollisions",value:function(e,t){}},{key:"onCollision",value:function(e){if(this._movable&&(null==this._vx||null==this._vy))throw"Error: Must store velocity in _vx and _vy for game collision objects!";if(this._movable&&e instanceof n){var t=_slicedToArray(this.__getDisplacementVector(),2),r=t[0],o=t[1],i=_slicedToArray(e.__getDisplacementVector(),2),a=i[0],l=i[1],s=e.__getCollisionSides(),u=this.__getCollisionSides(),c=n.sideSwaps;u=u.map(function(e,t,n){return n[c[t]]});for(var h=1/0,f=null,_=0;_<u.length;_++)if(null!=s[_]&&null!=u[_]){var d=_slicedToArray(this.__intersection(u[_],[r,o],s[_],[a,l]),3),p=d[0];d[1],d[2];h>p&&(h=p,f=_)}h!=1/0&&n.appendCollision(this,e,f,h)}n.finalPassDone=!1}},{key:"__collisionAdjust",value:function(e,t){var r=_slicedToArray(this.getHitBox(),4),o=(r[0],r[1],r[2]),i=r[3],a=_slicedToArray(e,3),l=_slicedToArray(a[0],2),s=l[0],u=l[1],c=a[1];a[2];if(this._movable){this.___covered[c]=!0;var h=n.sideSigns[t],f=s-(h+1)*o/2,_=u-(h+1)*i/2;this.x=0==c?this.x:f,this.y=1==c?this.y:_,this._vx*=!this.___covered[1],this._vy*=!this.___covered[0]}}},{key:"onCollisionEnd",value:function(){n.manageAllCollisions(),this.___px=this.x,this.___py=this.y,this.___covered=[!1,!1]}}],[{key:"manageAllCollisions",value:function(){if(!n.finalPassDone){var e=[];for(var t in n.collisions)e.push(n.collisions[t]);e.sort(function(e,t){return e[3]-t[3]});for(var r=n.sideSwaps,o=n.sideNames,i=0,a=e;i<a.length;i++){var l=_slicedToArray(a[i],4),s=l[0],u=l[1],c=l[2],h=(l[3],s.__getDisplacementVector()),f=u.__getDisplacementVector(),_=s.__getCollisionSides()[r[c]],d=u.__getCollisionSides()[c],p=_slicedToArray(s.__intersection(_,h,d,f),3),y=(p[0],p[1]),v=p[2];if(!(y<=0||null==v)){var m=_slicedToArray(v,3),k=_slicedToArray(m[0],2);k[0],k[1],m[1],m[2];s._solid&&u._solid&&(s.__collisionAdjust(v,c),u.__collisionAdjust(v,r[c])),s.handleCollisions(u,o[r[c]]),u.handleCollisions(s,o[c])}}n.objectIdx=0,n.objectMapping.clear(),n.collisions={},n.finalPassDone=!0}}},{key:"appendCollision",value:function(e,t,r,o){n.objectMapping.has(e)||n.objectMapping.set(e,n.objectIdx++),n.objectMapping.has(t)||n.objectMapping.set(t,n.objectIdx++);var i=[n.objectMapping.get(e),n.objectMapping.get(t)];i.sort(),i in n.collisions||(n.collisions[i]=[e,t,r,o])}}]),n}();function _loadChunk(e,t,n,r,o,i){for(var a=n.chunkSize,l=_makeEmptyChunk(a),s=0;s<a;s++)for(var u=0;u<a;u++){var c=n.chunks[e][t].blocks[s][u],h=null!=c?c._$type:null;l.blocks[s][u]=null!=h?r[h].fromJSON(c,n.blockSize,i):null}var f,_=_createForOfIteratorHelper(n.chunks[e][t].entities);try{for(_.s();!(f=_.n()).done;){var d=f.value;l.entities.push(o[d._$type].fromJSON(d,n.blockSize,i))}}catch(e){_.e(e)}finally{_.f()}return l}function _unloadChunk(e,t,n,r){for(var o=r.chunkSize,i=0;i<o;i++)for(var a=0;a<o;a++){var l=e.blocks[i][a];r.chunks[t][n].blocks[i][a]=null!=l?l.toJSON():null}r.chunks[t][n].entities=[];var s,u=_createForOfIteratorHelper(e.entities);try{for(u.s();!(s=u.n()).done;){var c=s.value;r.chunks[t][n].entities.push(c.toJSON())}}catch(e){u.e(e)}finally{u.f()}}function _flushLoadedChunks(e,t){var n,r=_createForOfIteratorHelper(t);try{for(r.s();!(n=r.n()).done;){var o=_slicedToArray(n.value,3),i=o[0],a=o[1];_unloadChunk(o[2],i,a,e)}}catch(e){r.e(e)}finally{r.f()}}function _manageChunks(e,t,n,r,o,i){var a,l=_slicedToArray(t.getBounds(),4),s=l[0],u=l[1],c=l[2],h=l[3],f=e.blockSize*e.chunkSize,_=Math.max(0,Math.floor(s/f)),d=Math.max(0,Math.floor(u/f)),p=Math.min(e.numChunks[0]-1,Math.ceil((s+c)/f)),y=Math.min(e.numChunks[1]-1,Math.ceil((u+h)/f)),v=[],m={},k=_createForOfIteratorHelper(n);try{for(k.s();!(a=k.n()).done;){var g=_slicedToArray(a.value,3),b=g[0],S=g[1],w=g[2];b<_||b>p||S<d||S>y?_unloadChunk(w,b,S,e):(v.push([b,S,w]),m[[b,S]]=!0)}}catch(e){k.e(e)}finally{k.f()}for(var C=_;C<=p;C++)for(var O=d;O<=y;O++)[C,O]in m||v.push([C,O,_loadChunk(C,O,e,r,o,i)]);return n=null,v}function _popAndSwapWithEnd(e,t){if(e.length>0){var n=e[t];return e[t]=e[e.length-1],e.length--,n}}function _findChunk(e,t,n){var r,o=_createForOfIteratorHelper(n);try{for(o.s();!(r=o.n()).done;){var i=_slicedToArray(r.value,3),a=i[0],l=i[1],s=i[2];if(a==e&&l==t)return s}}catch(e){o.e(e)}finally{o.f()}return null}function _gameObjListToMapping(e){var t,n={},r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var o=t.value;n[o.name]=o}}catch(e){r.e(e)}finally{r.f()}return n}function _gameObjMappingToList(e){var t=[];for(var n in e)t.push(e[n]);return t}GameCollisionObject.objectIdx=0,GameCollisionObject.objectMapping=new Map,GameCollisionObject.collisions={},GameCollisionObject.finalPassDone=!1,GameCollisionObject.sideNames=["bottom","top","right","left"],GameCollisionObject.sideSigns=[-1,1,-1,1],GameCollisionObject.sideSwaps=[1,0,3,2],window.GameCollisionObject=GameCollisionObject,elem_proto.makeGame=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var n,r,o,i,a,l,s,u,c,h,f,_,d,p,y=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:p=function(e,t,n){if(t.fillStyle="white",t.fillRect(0,0,e.width,e.height),!("preDraw"in a&&a.preDraw(e,t,n))){var r,o=_createForOfIteratorHelper(n.loadedChunks);try{for(o.s();!(r=o.n()).done;){var i,l=_slicedToArray(r.value,3),s=(l[0],l[1],l[2]),u=_createForOfIteratorHelper(s.blocks);try{for(u.s();!(i=u.n()).done;){var c,h=_createForOfIteratorHelper(i.value);try{for(h.s();!(c=h.n()).done;){var f=c.value;null!=f&&f.draw(n.canvas,n.painter,n.camera)}}catch(e){h.e(e)}finally{h.f()}}}catch(e){u.e(e)}finally{u.f()}var _,d=_createForOfIteratorHelper(s.entities);try{for(d.s();!(_=d.n()).done;){_.value.draw(n.canvas,n.painter,n.camera)}}catch(e){d.e(e)}finally{d.f()}}}catch(e){o.e(e)}finally{o.f()}n.__player.draw(n.canvas,n.painter,n.camera),"postDraw"in a&&a.postDraw(e,t,n)}},d=function(e,t){if(!("preUpdate"in a&&a.preUpdate(e,t))){var n,r=t.level.chunkSize,o=t.level.numChunks,i={},l=_createForOfIteratorHelper(t.loadedChunks);try{for(l.s();!(n=l.n()).done;){var s,_=_slicedToArray(n.value,3),d=_[0],p=_[1],y=_[2],v=_createForOfIteratorHelper(y.blocks);try{for(v.s();!(s=v.n()).done;){var m,k=s.value,g=0,b=_createForOfIteratorHelper(k);try{for(b.s();!(m=b.n()).done;){var S=m.value;null!=S&&S.update(e,t)&&(k[g]=null),g++}}catch(e){b.e(e)}finally{b.f()}}}catch(e){v.e(e)}finally{v.f()}for(var w=0;w<y.entities.length;w++){var C=y.entities[w];if(C.update(e,t))_popAndSwapWithEnd(y.entities,w);else{var O=_slicedToArray(u(C,r,o),2),T=O[0],A=O[1],x=[Math.floor(T/r),Math.floor(A/r)];if(A=x[1],(T=x[0])!=d||A!=p){_popAndSwapWithEnd(y.entities,w);var j=[T,A];j in i||(i[j]=[]),i[j].push(C)}}}}}catch(e){l.e(e)}finally{l.f()}var P,I=_createForOfIteratorHelper(t.loadedChunks);try{for(I.s();!(P=I.n()).done;){var M=_slicedToArray(P.value,3),H=M[0],z=M[1],E=M[2],L=[H,z];if(L in i){var B,R=_createForOfIteratorHelper(i[L]);try{for(R.s();!(B=R.n()).done;){var F=B.value;E.entities.push(F)}}catch(e){R.e(e)}finally{R.f()}delete i[L]}}}catch(e){I.e(e)}finally{I.f()}for(var G in i){var N=_slicedToArray(G,2),J=N[0],D=N[1];for(var $ in i[[J,D]])t.level.chunks[J][D].entities.push($.toJSON())}t.__player.update(e,t)?h(t):(u(t.__player,r,o),f(t.loadedChunks,t.chunkLookup,r,o,t.__player,t),t.camera.update(t.level.numChunks.map(function(e){return e*t.level.blockSize*t.level.chunkSize})),t.loadedChunks=_manageChunks(t.level,t.camera,t.loadedChunks,t.blockTypes,t.entityTypes,t.sprites),t.chunkLookup=c(t.loadedChunks),"postUpdate"in a&&a.postUpdate(e,t))}},_=function(e,t){if(null==t.__player){var n=t.level;t.__origLevel=JSON.parse(JSON.stringify(n)),t.__player=t.playerType.fromJSON(n.player,n.blockSize,t.sprites),t.camera.setTrackedObject(t.__player),t.chunkLookup={},t.addEntity=function(e){var t=_slicedToArray(u(e,this.level.chunkSize,this.level.numChunks),2),n=t[0],r=t[1],o=[Math.floor(n/this.level.chunkSize),Math.floor(r/this.level.chunkSize)];[n=o[0],r=o[1]]in this.chunkLookup?this.chunkLookup[[n,r]].entities.push(e):this.level.chunks[n][r].entities.push(e.toJSON())},t.addBlock=function(e){var t=_slicedToArray(u(e,this.level.chunkSize,this.level.numChunks),2),n=t[0],r=t[1],o=[Math.floor(n/this.level.chunkSize),Math.floor(r/this.level.chunkSize)],i=o[0],a=o[1],l=[Math.floor(n),Math.floor(r)];n=l[0],r=l[1],e.x=Math.floor(n),e.y=Math.floor(r);var s=n%this.level.chunkSize,c=r%this.level.chunkSize;[i,a]in this.chunkLookup?this.chunkLookup[[i,a]].blocks[s][c]=e:this.level.chunks[i][a].blocks[s][c]=e.toJSON()},t.getPlayer=function(){return t.__player},t.getNeighboringBlocks=function(e){for(var t=_slicedToArray(u(e,this.level.chunkSize,this.level.numChunks).map(Math.floor),2),n=t[0],r=t[1],o=[[null,null,null],[null,null,null],[null,null,null]],i=n-1,a=r-1,l=i;l<n+2;l++)for(var s=a;s<r+2;s++){var c=_slicedToArray([l/this.level.chunkSize,s/this.level.chunkSize].map(Math.floor),2),h=c[0],f=c[1],_=l%this.level.chunkSize,d=s%this.level.chunkSize;[h,f]in this.chunkLookup&&(o[l-i][s-a]=this.chunkLookup[[h,f]].blocks[_][d])}return o},t.getEntities=function(){var e,t=[],n=_createForOfIteratorHelper(this.loadedChunks);try{for(n.s();!(e=n.n()).done;){var r=_slicedToArray(e.value,3),o=(r[0],r[1],r[2]);t.push.apply(t,_toConsumableArray(o.entities))}}catch(e){n.e(e)}finally{n.f()}return t}}d(e,t),p(t.canvas,t.painter,t)},f=function(e,t,n,r,o,i){for(var a=function(e,t,n){return(arguments.length>3&&void 0!==arguments[3]?arguments[3]:Math.floor)(e=_bound(e,t,n))},l=function(e,t){return[Math.floor(e/t),Math.floor(e%t)]},s=0;s<e.length;s++)for(var u=_slicedToArray(e[s],3),c=(u[0],u[1],u[2]),f=0==s?-1:0;f<c.entities.length;f++){for(var _=f<0?o:c.entities[f],d=_slicedToArray(_.getHitBox(),4),p=d[0],y=d[1],v=d[2],m=d[3],k=a(p,0,n*r[0]-1),g=a(y,0,n*r[1]-1),b=a(p+v,0,n*r[0]-1),S=a(y+m,0,n*r[1]-1),w=k;w<=b;w++)for(var C=g;C<=S;C++){var O=_slicedToArray(l(w,n),2),T=O[0],A=O[1],x=_slicedToArray(l(C,n),2),j=x[0],P=x[1];if([T,j]in t){var I=t[[T,j]].blocks[A][P];if(null!=I){var M=_slicedToArray(I.getHitBox(),4),H=M[0],z=M[1],E=M[2],L=M[3];if(!(H>=p+v||H+E<=p||z>=y+m||z+L<=y)){if("onCollision"in _&&_.onCollision(I)&&f>=0){if(!(f>=0))return void h(i);_popAndSwapWithEnd(c.entities,f)}"onCollision"in I&&I.onCollision(_)&&(t[[T,j]].blocks[A][P]=null)}}}}for(var B=s;B<e.length;B++)for(var R=_slicedToArray(e[B],3),F=(R[0],R[1],R[2]),G=s==B?f+1:0;G<F.entities.length;G++){var N=F.entities[G],J=_slicedToArray(N.getHitBox(),4),D=J[0],$=J[1],W=J[2],U=J[3];if(!(D>=p+v||D+W<=p||$>=y+m||$+U<=y)){if("onCollision"in _&&_.onCollision(N)){if(!(f>=0))return void h(i);_popAndSwapWithEnd(c.entities,f)}"onCollision"in N&&N.onCollision(_)&&_popAndSwapWithEnd(F.entities,G)}}}var V,X=_createForOfIteratorHelper(e);try{for(X.s();!(V=X.n()).done;){var Y,K=_slicedToArray(V.value,3),q=(K[0],K[1],K[2]),Q=_createForOfIteratorHelper(q.blocks);try{for(Q.s();!(Y=Q.n()).done;){var Z,ee=_createForOfIteratorHelper(Y.value);try{for(ee.s();!(Z=ee.n()).done;){var te=Z.value;null!=te&&"onCollisionEnd"in te&&te.onCollisionEnd()}}catch(e){ee.e(e)}finally{ee.f()}}}catch(e){Q.e(e)}finally{Q.f()}var ne,re=_createForOfIteratorHelper(q.entities);try{for(re.s();!(ne=re.n()).done;){var oe=ne.value;"onCollisionEnd"in oe&&oe.onCollisionEnd()}}catch(e){re.e(e)}finally{re.f()}}}catch(e){X.e(e)}finally{X.f()}"onCollisionEnd"in o&&o.onCollisionEnd()},h=function(e){for(var t in e.level=JSON.parse(JSON.stringify(e.__origLevel)),e.level.player)e.__player[t]=e.level.player[t];e.loadedChunks=[],e.chunkLookup={}},c=function(e){var t,n={},r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var o=_slicedToArray(t.value,3),i=o[0],a=o[1],l=o[2];n[[i,a]]=l}}catch(e){r.e(e)}finally{r.f()}return n},u=function(e,t,n){var r=_slicedToArray(n,2),o=r[0],i=r[1],a=_slicedToArray(e.getHitBox(),4),l=a[0],s=a[1],u=a[2],c=a[3],h=[_bound(l,0,o*t-u),_bound(s,0,i*t-c)];return l=h[0],s=h[1],e.setLocation([l,s]),[l,s]},n=y.length>1&&void 0!==y[1]?y[1]:[],r=y.length>2&&void 0!==y[2]?y[2]:[],o=y.length>3&&void 0!==y[3]?y[3]:{},i=y.length>4&&void 0!==y[4]?y[4]:null,a=y.length>5&&void 0!==y[5]?y[5]:{},l=y.length>6&&void 0!==y[6]?y[6]:null,(s={}).entityTypes=_gameObjListToMapping(r),s.blockTypes=_gameObjListToMapping(n),s.loadedChunks=[],s.playerType=i,s.__player=null,o.level=t,this.makeBaseGame(_,s,o,null!=l?l:320);case 21:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}();
